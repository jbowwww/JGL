using System;
using System.Collections.Generic;
using System.IO;
using Glade;
using Gtk;
using System.Xml.Serialization;
using Dynamic;

namespace Dynamic.UI
{
	/// <summary>
	/// Project preferences dialog.
	/// </summary>
	public class ProjectPreferencesDialog : Gtk.Dialog
	{
		/// <summary>
		/// The project preferences to edit
		/// </summary>
		public readonly ProjectPreferences Preferences;

		/// <summary>
		/// Get the <see cref="Gtk.Window"/> corresponding to this instance. Gets set during construction
		/// </summary>
		public readonly Dialog GtkDialog;

		/// <summary>
		/// Preferences <see cref="Notebook"/>
		/// </summary>
		[Widget]
		public Notebook nbPreferences;

		/// <summary>
		/// The text reference paths.
		/// </summary>
		[Widget]
		public ScrolledWindow swReferencePaths;

		/// <summary>
		/// The store reference paths.
		/// </summary>
		public NodeStore storeReferencePaths;

		/// <summary>
		/// The nv reference paths.
		/// </summary>
		public NodeView nvReferencePaths;

		/// <summary>
		/// Initializes a new instance of the <see cref="DynamicCodeTests.UI.ProjectPreferencesDialog"/> class.
		/// </summary>
		public ProjectPreferencesDialog(Window parent, ProjectPreferences preferences)
		{
			Preferences = preferences;

			XML gxml = new XML("CodeWindow.glade", "ProjectPreferencesDialog", null);
			gxml.Autoconnect(this);
			GtkDialog = nbPreferences.Toplevel as Dialog;
//			GtkDialog.Reparent(parent as Widget);
			GtkDialog.Modal = GtkDialog.DestroyWithParent = true;
			GtkDialog.Close += (sender, e) => { GtkDialog.Respond(ResponseType.Cancel); };

			storeReferencePaths = new NodeStore(typeof(ProjectPreferences.ReferencePathTreeNode));
			nvReferencePaths = new NodeView(storeReferencePaths);
			swReferencePaths.Add(nvReferencePaths);

			nvReferencePaths.AppendColumn("Reference Path", new CellRendererText(), "text", 0);

			Update();
		}

		/// <summary>
		/// Update (load from or save to <see cref="Preferences"/>) dialog values
		/// </summary>
		/// <param name='save'>Whether this call should update dialog's control's from <see cref="Preferences"/>, or save the values to <see cref="Preferences"/></param>
		public void Update(bool save = false)
		{
			storeReferencePaths.Clear();
			foreach (string refPath in ReferencePaths)
				storeReferencePaths.AddNode(new ReferencePathTreeNode() { Path = refPath });
			nvReferencePaths.ShowAll();
		}

		protected void AddReference(object sender, EventArgs args)
		{
			FileChooserDialog fDlg = new FileChooserDialog("Select Assembly", GtkDialog as Window, FileChooserAction.Open, "Cancel", ResponseType.Cancel, "Open", ResponseType.Accept);
			fDlg.Modal = true;
			fDlg.DestroyWithParent = true;
			fDlg.Close += (s, e) => { fDlg.Respond(ResponseType.Cancel); };
			if (fDlg.Run() == (int)ResponseType.Accept)
			{
				string path = fDlg.Filename;
				if (!File.Exists(path))
					throw new FileNotFoundException("Could not open assembly to add to project preferences", path);
				if (!ReferencePaths.Contains(path))
					ReferencePaths.Add(path);
				Update();
			}
			fDlg.Destroy();
		}

		protected void RemoveReference(object sender, EventArgs args)
		{
			TreeIter ti;
			if (nvReferencePaths.NodeSelection.SelectedNodes.Length > 0)
			{
				foreach (ITreeNode tn in nvReferencePaths.NodeSelection.SelectedNodes)
					ReferencePaths.Remove((tn as ReferencePathTreeNode).Path);
				Update();
			}
		}
	}
}

